#NS13.1 Build 61.23
# High Availability and Cluster Configuration
# Purpose: Test HA/Cluster parsing and feature detection
# Note: Synthetic config - HA requires multiple physical/virtual nodes

# ============================================================================
# HA NODE CONFIGURATION
# ============================================================================
# Primary node configuration
add ha node 1 10.1.1.2 -inc ENABLED
set ha node -failSafe ON -maxFlips 3 -maxFlipTime 1200

# HA node settings
set ha node -helloInterval 200 -deadInterval 3 -preemption DISABLED

# ============================================================================
# HA SYNC CONFIGURATION
# ============================================================================
# NSIP addresses for HA pair
add ns ip 10.1.1.1 255.255.255.0 -type NSIP -mgmtAccess ENABLED -arp ENABLED
add ns ip 10.1.1.2 255.255.255.0 -type NSIP -mgmtAccess ENABLED

# SNIP for client traffic
add ns ip 10.1.1.10 255.255.255.0 -type SNIP -mgmtAccess DISABLED

# VIP for HA floating
add ns ip 10.1.1.100 255.255.255.0 -type VIP

# ============================================================================
# RPC NODE (Cluster Communication)
# ============================================================================
add ns rpcNode 10.1.1.2 -srcIP 10.1.1.1 -secure YES

# ============================================================================
# HA FAILOVER INTERFACE
# ============================================================================
# Interface used for HA heartbeat
set interface 0/1 -haMonitor ON -haHeartbeat ON
set interface 0/2 -haMonitor ON -haHeartbeat OFF

# ============================================================================
# HA FILE SYNC
# ============================================================================
# Files to sync between HA nodes
add ns config syncfilespec /nsconfig/ssl/*.crt
add ns config syncfilespec /nsconfig/ssl/*.key
add ns config syncfilespec /nsconfig/monitors/*.pl

# ============================================================================
# CLUSTER CONFIGURATION
# ============================================================================
# Cluster instance
add cluster instance cluster_prod -inc ENABLED -backplaneBasedView ENABLED -processLocal ENABLED

# Cluster nodes
add cluster node 0 10.1.1.1 -state ACTIVE -backplane 0/1/1 -priority 31
add cluster node 1 10.1.1.2 -state ACTIVE -backplane 0/1/2 -priority 30
add cluster node 2 10.1.1.3 -state PASSIVE -backplane 0/1/3 -priority 29

# Cluster IP (CLIP)
add ns ip 10.1.1.50 255.255.255.0 -type CLIP -ownerNode 0

# ============================================================================
# CLUSTER NODE GROUPS
# ============================================================================
add cluster nodegroup ng_active -strict YES
bind cluster nodegroup ng_active 0
bind cluster nodegroup ng_active 1

add cluster nodegroup ng_all
bind cluster nodegroup ng_all 0
bind cluster nodegroup ng_all 1
bind cluster nodegroup ng_all 2

# ============================================================================
# STRIPED AND SPOTTED IP CONFIGURATION
# ============================================================================
# Striped IP (traffic distributed across nodes)
add ns ip 10.1.1.60 255.255.255.0 -type SNIP -ownerNode -1 -ownerDownResponse ACCEPT

# Spotted IP (specific to one node)
add ns ip 10.1.1.61 255.255.255.0 -type SNIP -ownerNode 0

# ============================================================================
# HA MONITORING
# ============================================================================
# Link failover monitoring
set interface 0/1 -linkRedundancy ON -lrMinThroughput 1000
add ha failover interface 0/1 -monitorInterface 0/2

# HA route monitor
add route 0.0.0.0 0.0.0.0 10.1.1.254 -haMonitor YES

# ============================================================================
# HA PROPAGATION
# ============================================================================
# Enable config propagation
set ha node -propState ENABLED

# Sync VLAN
set ha node -syncVlan 100

# ============================================================================
# CLUSTER vServer OWNERSHIP
# ============================================================================
# vServer bound to specific node group
add lb vserver lb_cluster_vs HTTP 10.1.1.100 80 -ownerGroup ng_active

# Spotted vServer (runs on specific node)
add lb vserver lb_spotted_vs HTTP 10.1.1.101 80

# ============================================================================
# GSLB SITE AWARENESS (HA Integration)
# ============================================================================
add gslb site local_site 10.1.1.1 -publicIP 203.0.113.1 -clip 10.1.1.50

# ============================================================================
# HA STATUS COMMANDS (Reference)
# ============================================================================
# show ha node
# show cluster instance
# show cluster node
# show cluster nodegroup
# force ha failover
# force ha sync

# ============================================================================
# SAMPLE HA VSERVER CONFIGURATION
# ============================================================================
add server backend1 10.10.1.10
add server backend2 10.10.1.11
add serviceGroup sg_ha_web HTTP
bind serviceGroup sg_ha_web backend1 80
bind serviceGroup sg_ha_web backend2 80
bind lb vserver lb_cluster_vs sg_ha_web

# SSL for HA vserver
add ssl certKey ha_cert -cert /nsconfig/ssl/ha.example.com.crt -key /nsconfig/ssl/ha.example.com.key
bind ssl vserver lb_cluster_vs -certkeyName ha_cert
