#NS13.1 Build 61.23
# SAML Authentication Configuration
# Purpose: Test SAML SSO parsing (SP and IdP modes)
# Note: Synthetic config - requires SAML IdP for full testing

# ============================================================================
# SSL CERTIFICATES FOR SAML
# ============================================================================
# SP signing certificate
add ssl certKey saml_sp_cert -cert /nsconfig/ssl/saml_sp.crt -key /nsconfig/ssl/saml_sp.key

# IdP certificate (from external IdP)
add ssl certKey saml_idp_cert -cert /nsconfig/ssl/okta_idp.crt

# ============================================================================
# SAML SP CONFIGURATION (Service Provider Mode)
# ============================================================================
# SAML Action - Okta as IdP
add authentication samlAction saml_act_okta -metadataUrl "https://dev-12345.okta.com/app/metadata/saml" -samlIdPCertName saml_idp_cert -samlSigningCertName saml_sp_cert -samlRedirectUrl "https://ns.example.com/cgi/samlauth" -samlACSIndex 0 -samlBinding POST -relaystateRule "HTTP.REQ.URL" -signAssertion ON -encryptAssertion ON -samlIssuerName "https://ns.example.com/saml/sp" -logoutURL "https://dev-12345.okta.com/logout" -logoutBinding POST

# SAML Action - Azure AD as IdP
add authentication samlAction saml_act_azure -metadataUrl "https://login.microsoftonline.com/tenant-id/federationmetadata/2007-06/federationmetadata.xml" -samlIdPCertName saml_idp_cert -samlSigningCertName saml_sp_cert -samlRedirectUrl "https://ns.example.com/cgi/samlauth" -samlBinding REDIRECT -samlIssuerName "https://ns.example.com" -Attribute1 "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress" -Attribute1Expr "AAA.USER.ATTRIBUTE(1)" -groupNameField "http://schemas.microsoft.com/ws/2008/06/identity/claims/groups"

# SAML Action - ADFS as IdP
add authentication samlAction saml_act_adfs -metadataUrl "https://adfs.corp.example.com/FederationMetadata/2007-06/FederationMetadata.xml" -samlIdPCertName saml_idp_cert -samlSigningCertName saml_sp_cert -samlRedirectUrl "https://ns.example.com/cgi/samlauth" -samlBinding POST -forceAuthn ON -requestedAuthnContext exact -authnCtxClassRef "urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport"

# ============================================================================
# SAML AUTHENTICATION POLICIES
# ============================================================================
add authentication Policy pol_saml_okta -rule "HTTP.REQ.HEADER(\"Host\").EQ(\"okta.example.com\")" -action saml_act_okta
add authentication Policy pol_saml_azure -rule "HTTP.REQ.HEADER(\"Host\").EQ(\"azure.example.com\")" -action saml_act_azure
add authentication Policy pol_saml_adfs -rule "true" -action saml_act_adfs

# ============================================================================
# SAML IDP CONFIGURATION (Identity Provider Mode)
# ============================================================================
# SAML IdP Profile - NetScaler as IdP
add authentication samlIdPProfile saml_idp_prof_ns -samlIdPCertName saml_sp_cert -samlSPCertName saml_idp_cert -samlIssuerName "https://ns.example.com/saml/idp" -assertionConsumerServiceURL "https://app.example.com/saml/acs" -rejectUnsignedRequests ON -signAssertion ON -encryptAssertion OFF -NameIDFormat EmailAddress -NameIDExpr "AAA.USER.ATTRIBUTE(\"mail\")" -Audience "https://app.example.com" -serviceProviderID "https://app.example.com/saml/metadata" -defaultAuthenticationGroup "SAML_Users" -signatureAlg RSA-SHA256 -digestMethod SHA256 -sendPassword ON

# Additional IdP profile for different SP
add authentication samlIdPProfile saml_idp_prof_salesforce -samlIdPCertName saml_sp_cert -assertionConsumerServiceURL "https://login.salesforce.com" -samlIssuerName "https://ns.example.com" -NameIDFormat unspecified -NameIDExpr "AAA.USER.ATTRIBUTE(\"upn\")" -Audience "https://saml.salesforce.com" -Attribute1 "User.Email" -Attribute1Expr "AAA.USER.ATTRIBUTE(\"mail\")" -Attribute1FriendlyName "email" -Attribute2 "User.FirstName" -Attribute2Expr "AAA.USER.ATTRIBUTE(\"givenName\")" -Attribute2FriendlyName "firstName"

# ============================================================================
# SAML IDP POLICIES
# ============================================================================
add authentication samlIdPPolicy saml_idp_pol_default -rule "true" -action saml_idp_prof_ns
add authentication samlIdPPolicy saml_idp_pol_salesforce -rule "HTTP.REQ.URL.QUERY.VALUE(\"SAMLRequest\").CONTAINS(\"salesforce\")" -action saml_idp_prof_salesforce

# ============================================================================
# AUTHENTICATION VSERVER FOR SAML SP
# ============================================================================
add authentication vserver auth_vs_saml SSL 10.1.1.210 443 -authenticationDomain example.com
bind ssl vserver auth_vs_saml -certkeyName saml_sp_cert

# Bind SAML policies
bind authentication vserver auth_vs_saml -policy pol_saml_okta -priority 100 -gotoPriorityExpression END
bind authentication vserver auth_vs_saml -policy pol_saml_azure -priority 200 -gotoPriorityExpression END
bind authentication vserver auth_vs_saml -policy pol_saml_adfs -priority 1000 -gotoPriorityExpression END

# ============================================================================
# AUTHENTICATION VSERVER FOR SAML IDP
# ============================================================================
add authentication vserver auth_vs_idp SSL 10.1.1.211 443 -authenticationDomain example.com
bind ssl vserver auth_vs_idp -certkeyName saml_sp_cert

# Bind IdP policies
bind authentication vserver auth_vs_idp -policy saml_idp_pol_salesforce -priority 100 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_idp -policy saml_idp_pol_default -priority 1000 -gotoPriorityExpression END

# ============================================================================
# LDAP BACKEND FOR IDP AUTHENTICATION
# ============================================================================
add authentication ldapAction ldap_act_idp_backend -serverIP 10.1.2.10 -serverPort 389 -ldapBase "DC=corp,DC=example,DC=com" -ldapBindDn "CN=svc_saml,OU=Service,DC=corp,DC=example,DC=com" -ldapBindDnPassword "encrypted_password" -ldapLoginName sAMAccountName -groupAttrName memberOf -subAttributeName CN

add authentication Policy pol_ldap_idp -rule "true" -action ldap_act_idp_backend

# Bind LDAP as authentication backend for IdP
bind authentication vserver auth_vs_idp -policy pol_ldap_idp -priority 50 -gotoPriorityExpression NEXT

# ============================================================================
# APPLICATION VSERVER WITH SAML AUTH
# ============================================================================
add lb vserver lb_saml_app SSL 10.1.1.220 443 -authentication ON -authnVsName auth_vs_saml
add serviceGroup sg_saml_app HTTP
add server samlapp1 10.10.1.50
bind serviceGroup sg_saml_app samlapp1 8080
bind lb vserver lb_saml_app sg_saml_app
bind ssl vserver lb_saml_app -certkeyName saml_sp_cert

# ============================================================================
# SESSION POLICY FOR SAML ATTRIBUTES
# ============================================================================
add tm sessionAction session_act_saml -SSO ON -ssoCredential PRIMARY -homepage "/dashboard" -persistentCookie ENABLED

add tm sessionPolicy session_pol_saml "AAA.USER.IS_MEMBER_OF(\"SAML_Users\")" session_act_saml

bind lb vserver lb_saml_app -policyName session_pol_saml -priority 100 -type REQUEST

# ============================================================================
# SAML METADATA ENDPOINT
# ============================================================================
# Responder for SP metadata
add responder action resp_saml_metadata respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: application/xml\\r\\n\\r\\n\" + SYS.HTTP_CALLOUT(\"saml_metadata_callout\")"
add responder policy resp_pol_saml_metadata "HTTP.REQ.URL.PATH.EQ(\"/saml/metadata\")" resp_saml_metadata

# ============================================================================
# LOGOUT HANDLING
# ============================================================================
add authentication logoutAction logout_act_saml -logoutURL "https://dev-12345.okta.com/logout"
add authentication logoutPolicy logout_pol_saml -rule "HTTP.REQ.URL.PATH.EQ(\"/logout\")" -action logout_act_saml
