#NS13.1 Build 61.23
# Custom Monitors Configuration
# Purpose: Test script-based and custom monitor parsing
# Note: Synthetic config for USER type monitors

# == HTTP Monitor with Custom Headers ==
add lb monitor http_custom HTTP -respCode 200 -httpRequest "GET /health HTTP/1.1\r\nHost: example.com\r\nAccept: application/json\r\n\r\n" -recv "OK" -LRTM ENABLED
add lb monitor http_host HTTP -respCode 200 -customHeaders "Host: internal.example.com\r\nX-Forwarded-Proto: https\r\n" -httpRequest "GET /status HTTP/1.1\r\n\r\n"

# == HTTP-ECV Monitor (Extended Content Verification) ==
add lb monitor http_ecv HTTP-ECV -send "GET /healthz HTTP/1.1\r\nHost: app.example.com\r\nConnection: close\r\n\r\n" -recv "healthy" -respCode 200 -LRTM ENABLED
add lb monitor https_ecv HTTP-ECV -secure YES -send "GET /api/health HTTP/1.1\r\nHost: secure.example.com\r\n\r\n" -recv "\"status\":\"up\"" -respCode 200

# == TCP Monitor with Send/Receive ==
add lb monitor tcp_custom TCP -send "PING\r\n" -recv "PONG" -LRTM ENABLED
add lb monitor tcp_redis TCP -send "PING\r\n" -recv "+PONG" -destPort 6379
add lb monitor tcp_memcache TCP -send "stats\r\n" -recv "STAT" -destPort 11211

# == TCP-ECV Monitor ==
add lb monitor tcp_ecv TCP-ECV -send "GET / HTTP/1.0\r\n\r\n" -recv "HTTP" -LRTM ENABLED

# == Script-based Monitors (USER type) ==
add lb monitor script_db USER -scriptName nsmysql.pl -scriptArgs "database=mydb;user=monitor;password=secret" -dispatcherIP 127.0.0.1 -dispatcherPort 3013
add lb monitor script_api USER -scriptName nshttp.pl -scriptArgs "url=https://api.example.com/status;method=GET" -dispatcherIP 127.0.0.1 -dispatcherPort 3013
add lb monitor script_ldap USER -scriptName nsldap.pl -scriptArgs "host=ldap.example.com;port=389;base=dc=example,dc=com" -dispatcherIP 127.0.0.1 -dispatcherPort 3013
add lb monitor script_custom USER -scriptName custom_check.pl -scriptArgs "host=target;timeout=5" -dispatcherIP 127.0.0.1 -dispatcherPort 3013 -LRTM ENABLED

# == LDAP Monitor ==
add lb monitor ldap_mon LDAP -scriptName nsldap.pl -ldapBase "dc=example,dc=com" -ldapBindDn "cn=monitor,dc=example,dc=com" -ldapBindDnPassword encrypted_password -ldapLoginName sAMAccountName -dispatcherIP 127.0.0.1 -dispatcherPort 3013

# == RADIUS Monitor ==
add lb monitor radius_mon RADIUS -userName testuser -password testpass -radKey sharedsecret -destPort 1812

# == DNS Monitor ==
add lb monitor dns_mon DNS -query example.com -queryType Address -respCode 0 -destPort 53 -LRTM ENABLED

# == MySQL/MSSQL Monitors ==
add lb monitor mysql_mon MYSQL -userName monitor -database testdb -sqlQuery "SELECT 1" -evalRule "MYSQL.RES.ATLEAST_ROWS_COUNT(1)"
add lb monitor mssql_mon MSSQL-ECV -userName monitor -database testdb -sqlQuery "SELECT 1" -evalRule "MSSQL.RES.STATUS.EQ(OK)"

# == FTP Monitor ==
add lb monitor ftp_mon FTP -userName anonymous -password test@example.com -destPort 21

# == SMTP Monitor ==
add lb monitor smtp_mon SMTP -destPort 25
add lb monitor smtp_ecv SMTP-ECV -send "EHLO monitor.example.com\r\n" -recv "250" -destPort 25

# == POP3/IMAP Monitors ==
add lb monitor pop3_mon POP3 -destPort 110
add lb monitor imap_mon IMAP -destPort 143

# == SIP Monitor ==
add lb monitor sip_mon SIP-UDP -sipURI sip:test@example.com -sipMethod OPTIONS -destPort 5060

# == SNMP Monitor ==
add lb monitor snmp_mon SNMP -snmpOID 1.3.6.1.2.1.1.3.0 -snmpCommunity public -destPort 161

# == StoreFront Monitor ==
add lb monitor storefront_mon STOREFRONT -storename Store -storefrontacctservice YES

# == Citrix ADC Monitors ==
add lb monitor citrix_adc_mon CITRIX-ADC-VPX -userName nsroot -password nsroot

# == Service Groups with Multiple Monitors ==
add serviceGroup sg_web_monitored HTTP -maxClient 1000
add server webserver1 10.10.1.10
add server webserver2 10.10.1.11
add server webserver3 10.10.1.12
bind serviceGroup sg_web_monitored webserver1 80
bind serviceGroup sg_web_monitored webserver2 80
bind serviceGroup sg_web_monitored webserver3 80
bind serviceGroup sg_web_monitored -monitorName http_custom
bind serviceGroup sg_web_monitored -monitorName tcp_custom -weight 2

# == Service with Custom Monitor ==
add service svc_api webserver1 HTTP 8080
bind service svc_api -monitorName http_ecv
bind service svc_api -monitorName script_api -weight 1

# == Monitor Interval/Timeout Settings ==
set lb monitor http_custom -interval 10 -resptimeout 5 -retries 3 -failureRetries 3 -alertRetries 1
set lb monitor script_db -interval 30 -resptimeout 20 -retries 2

# == Secure Monitors ==
set lb monitor https_ecv -secure YES -sslProfile ns_default_ssl_profile_backend

# == vServer with Monitored Service Group ==
add lb vserver lb_monitored_vs HTTP 10.1.1.100 80
bind lb vserver lb_monitored_vs sg_web_monitored
