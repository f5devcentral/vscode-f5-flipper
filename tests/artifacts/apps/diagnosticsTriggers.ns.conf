#NS13.1 Build 61.23
# Diagnostics Triggers Configuration
# Purpose: Trigger specific diagnostic rules in diagnostics.json
# Note: Synthetic config - some features require specific licensing

# == Trigger: f62e - Wildcard port (XC) ==
add lb vserver wildcard_port_vs HTTP 10.1.1.100 0
add lb vserver wildcard_port_ssl SSL 10.1.1.101 0

# == Trigger: 62ff - Wildcard VIP (XC) ==
add lb vserver wildcard_vip_vs HTTP 0.0.0.0 80
add lb vserver wildcard_vip_ssl SSL 0.0.0.0 443

# == Trigger: 3a67 - Client Certificate Auth (XC) ==
add ssl profile mtls_prof -clientAuth ENABLED -clientCert MANDATORY
add lb vserver mtls_vs SSL 10.1.1.102 443
set ssl vserver mtls_vs -clientAuth ENABLED -clientCert Mandatory
bind ssl vserver mtls_vs -sslProfile mtls_prof

# == Trigger: 4987 - Weak SSL Protocols ==
add ssl profile weak_ssl_prof -ssl3 ENABLED -tls1 ENABLED -tls11 ENABLED -tls12 DISABLED -tls13 DISABLED
add lb vserver weak_ssl_vs SSL 10.1.1.103 443
bind ssl vserver weak_ssl_vs -sslProfile weak_ssl_prof

# == Trigger: 5a5a - Advanced LB Methods (XC) ==
add lb vserver advanced_lb_lrt HTTP 10.1.1.110 80 -lbMethod LEASTRESPONSETIME
add lb vserver advanced_lb_lbw HTTP 10.1.1.111 80 -lbMethod LEASTBANDWIDTH
add lb vserver advanced_lb_lpkts HTTP 10.1.1.112 80 -lbMethod LEASTPACKETS
add lb vserver advanced_lb_token HTTP 10.1.1.113 80 -lbMethod TOKEN
add lb vserver advanced_lb_srcip HTTP 10.1.1.114 80 -lbMethod SRCIPHASH
add lb vserver advanced_lb_srcipdst HTTP 10.1.1.115 80 -lbMethod SRCIPDESTIPHASH
add lb vserver advanced_lb_urlhash HTTP 10.1.1.116 80 -lbMethod URLHASH
add lb vserver advanced_lb_callid HTTP 10.1.1.117 80 -lbMethod CALLIDHASH

# == Trigger: 681f - Rate Limiting ==
add lb vserver rate_limit_vs HTTP 10.1.1.120 80 -maxClient 1000
set lb vserver rate_limit_vs -surgeProtection ON
set ns httpParam -maxReusePool 1000
add ns limitSelector limit_sel_client -rule "CLIENT.IP.SRC"
add ns limitIdentifier limit_api -threshold 100 -timeSlice 60000 -mode REQUEST_RATE

# == Trigger: 3955 - Script Monitors (NGINX) ==
add lb monitor script_mon USER -scriptName custom_check.pl -scriptArgs "host=web" -dispatcherIP 127.0.0.1 -dispatcherPort 3013

# == Trigger: 5617 - Backup vServer ==
add lb vserver primary_vs HTTP 10.1.1.130 80
add lb vserver backup_vs HTTP 10.1.1.200 80
set lb vserver primary_vs -backupVServer backup_vs
add lb vserver primary_ssl SSL 10.1.1.131 443 -backupVServer backup_vs

# == Trigger: 0a0a - GSLB Complexity ==
add gslb site gslb_dc1 10.1.1.1 -publicIP 203.0.113.1
add gslb service gslb_svc gslb_dc1 10.1.1.100 HTTP 80 -publicIP 203.0.113.10
add gslb vserver gslb_vs HTTP -dnsRecordType A
bind gslb vserver gslb_vs -serviceName gslb_svc

# == Trigger: 81b2 - Authentication Policies ==
add authentication ldapAction ldap_act -serverIP 10.1.2.10 -serverPort 389 -ldapBase "dc=example,dc=com"
add authentication Policy auth_pol -rule "true" -action ldap_act
add authentication vserver auth_vs SSL 10.1.1.150 443 -authenticationDomain example.com
bind authentication vserver auth_vs -policy auth_pol -priority 100

# == Trigger: 016e - Rewrite Policies ==
add rewrite action rw_act_replace replace "HTTP.REQ.HEADER(\"Host\")" "\"new.example.com\""
add rewrite action rw_act_insert insert_http_header "X-Forwarded-Proto" "\"https\""
add rewrite action rw_act_delete delete_http_header "Server"
add rewrite policy rw_pol_replace "HTTP.REQ.HEADER(\"Host\").EXISTS" rw_act_replace
add rewrite policy rw_pol_insert "true" rw_act_insert

# == Trigger: 232e - Responder Policies ==
add responder action resp_act_redirect redirect "\"https://\" + HTTP.REQ.HOSTNAME + HTTP.REQ.URL"
add responder action resp_act_respond respondwith "\"HTTP/1.1 503 Service Unavailable\\r\\n\\r\\n\""
add responder action resp_act_drop DROP
add responder policy resp_pol_redirect "HTTP.REQ.IS_VALID && CLIENT.SSL.IS_SSL.NOT" resp_act_redirect
add responder policy resp_pol_maintenance "HTTP.REQ.URL.CONTAINS(\"/maintenance\")" resp_act_respond

# == Trigger: Content Switching ==
add cs vserver cs_trigger_vs HTTP 10.1.1.160 80
add cs action cs_act_backend -targetLBVserver primary_vs
add cs policy cs_pol_api -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/api/\")" -action cs_act_backend
bind cs vserver cs_trigger_vs -policyName cs_pol_api -priority 100

# == Trigger: SSL Certificate Bindings ==
add ssl certKey test_cert -cert /nsconfig/ssl/test.crt -key /nsconfig/ssl/test.key
bind ssl vserver primary_ssl -certkeyName test_cert
bind ssl vserver mtls_vs -certkeyName test_cert

# == Trigger: Persistence Types ==
add lb vserver persist_cookie_vs HTTP 10.1.1.170 80 -persistenceType COOKIEINSERT
add lb vserver persist_ssl_vs SSL 10.1.1.171 443 -persistenceType SSLSESSION
add lb vserver persist_srcip_vs HTTP 10.1.1.172 80 -persistenceType SOURCEIP
add lb vserver persist_destip_vs HTTP 10.1.1.173 80 -persistenceType DESTIP
add lb vserver persist_rule_vs HTTP 10.1.1.174 80 -persistenceType RULE -rule "HTTP.REQ.HEADER(\"X-Session-ID\")"

# == Trigger: AppFlow ==
add appflow collector collector1 -IPAddress 10.1.2.50 -port 4739
add appflow action af_action -collectors collector1
add appflow policy af_policy "true" af_action
bind appflow global af_policy 100 END -type REQ_DEFAULT

# == Trigger: Cache Policies ==
add cache contentGroup cache_group -maxResSize 500000 -memLimit 104857600
add cache policy cache_pol_static -rule "HTTP.REQ.URL.PATH.ENDSWITH(\".css\") || HTTP.REQ.URL.PATH.ENDSWITH(\".js\")" -action CACHE

# == Trigger: Compression ==
add cmp policy cmp_pol_text -rule "HTTP.RES.HEADER(\"Content-Type\").CONTAINS(\"text\")" -resAction COMPRESS

# == Service Groups and Servers ==
add server backend1 10.10.1.10
add server backend2 10.10.1.11
add serviceGroup sg_backend HTTP
bind serviceGroup sg_backend backend1 80
bind serviceGroup sg_backend backend2 80
bind lb vserver primary_vs sg_backend
bind lb vserver backup_vs sg_backend
