# Section 1.4: Cache Policies
# Tests: cache contentGroup, cache selector, cache policy
# Requires: enable ns feature IC

# Cache Content Groups
add cache contentGroup images_group -maxResSize 500000 -memLimit 100
add cache contentGroup static_group -maxResSize 1000000 -relExpiry 3600

# Cache Selectors (syntax: add cache selector <name> <expr1> [<expr2>...])
add cache selector cache_sel_url HTTP.REQ.URL.PATH
add cache selector cache_sel_host HTTP.REQ.HEADER("Host")

# Cache Policies
add cache policy cache_pol_images -rule "HTTP.REQ.URL.CONTAINS(\"/images/\")" -action CACHE -storeInGroup images_group
add cache policy cache_pol_static -rule "HTTP.REQ.URL.ENDSWITH(\".css\") || HTTP.REQ.URL.ENDSWITH(\".js\")" -action CACHE -storeInGroup static_group
add cache policy cache_pol_nocache -rule "HTTP.REQ.URL.CONTAINS(\"/api/\")" -action NOCACHE

# Backend and vserver
add server cache_server 10.10.10.30
add serviceGroup sg_cache HTTP
bind serviceGroup sg_cache cache_server 80
add lb vserver vs_cache HTTP 10.1.1.110 80
bind lb vserver vs_cache sg_cache

# Bind cache policies to vserver
bind lb vserver vs_cache -policyName cache_pol_images -priority 100 -gotoPriorityExpression END -type REQUEST
bind lb vserver vs_cache -policyName cache_pol_static -priority 200 -gotoPriorityExpression END -type REQUEST
bind lb vserver vs_cache -policyName cache_pol_nocache -priority 300 -gotoPriorityExpression END -type REQUEST
