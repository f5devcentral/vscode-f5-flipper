#NS13.1 Build 61.23
# OAuth/OIDC Authentication Configuration
# Purpose: Test OAuth and OpenID Connect parsing
# Note: Synthetic config - requires OAuth provider for full testing

# ============================================================================
# OAUTH ACTIONS (Client/Relying Party Mode)
# ============================================================================
# Azure AD OAuth
add authentication OAuthAction oauth_act_azure -authorizationEndpoint "https://login.microsoftonline.com/tenant-id/oauth2/v2.0/authorize" -tokenEndpoint "https://login.microsoftonline.com/tenant-id/oauth2/v2.0/token" -clientID "application-client-id" -clientSecret "encrypted_client_secret" -defaultAuthenticationGroup "Azure_Users" -Attribute1 "email" -Attribute2 "name" -Attribute3 "preferred_username" -tenantID "tenant-id" -GraphEndpoint "https://graph.microsoft.com" -refreshInterval 50 -certEndpoint "https://login.microsoftonline.com/tenant-id/discovery/v2.0/keys"

# Google OAuth
add authentication OAuthAction oauth_act_google -authorizationEndpoint "https://accounts.google.com/o/oauth2/v2/auth" -tokenEndpoint "https://oauth2.googleapis.com/token" -clientID "google-client-id.apps.googleusercontent.com" -clientSecret "encrypted_secret" -defaultAuthenticationGroup "Google_Users" -Attribute1 "email" -Attribute2 "name" -Attribute3 "picture" -audience "google-client-id.apps.googleusercontent.com" -userNameField "email" -certEndpoint "https://www.googleapis.com/oauth2/v3/certs" -authentication ENABLED -grantTypeSAMLBearer ON

# Okta OAuth/OIDC
add authentication OAuthAction oauth_act_okta -authorizationEndpoint "https://dev-12345.okta.com/oauth2/default/v1/authorize" -tokenEndpoint "https://dev-12345.okta.com/oauth2/default/v1/token" -idtokenDecryptEndpoint "https://dev-12345.okta.com/oauth2/default/v1/keys" -clientID "okta-client-id" -clientSecret "encrypted_secret" -defaultAuthenticationGroup "Okta_Users" -introspectURL "https://dev-12345.okta.com/oauth2/default/v1/introspect" -Attribute1 "sub" -Attribute2 "email" -Attribute3 "groups" -audience "api://default" -certEndpoint "https://dev-12345.okta.com/oauth2/default/v1/keys" -issuer "https://dev-12345.okta.com/oauth2/default"

# Generic OIDC Provider
add authentication OAuthAction oauth_act_oidc -authorizationEndpoint "https://idp.example.com/authorize" -tokenEndpoint "https://idp.example.com/token" -clientID "ns-client-id" -clientSecret "encrypted_secret" -defaultAuthenticationGroup "OIDC_Users" -certEndpoint "https://idp.example.com/.well-known/jwks.json" -issuer "https://idp.example.com" -metadataURL "https://idp.example.com/.well-known/openid-configuration" -userNameField "sub" -grantTypeSAMLBearer OFF -PKCERequired ON

# ============================================================================
# OAUTH AUTHENTICATION POLICIES
# ============================================================================
add authentication Policy pol_oauth_azure -rule "HTTP.REQ.HEADER(\"Host\").CONTAINS(\"azure\")" -action oauth_act_azure
add authentication Policy pol_oauth_google -rule "HTTP.REQ.HEADER(\"Host\").CONTAINS(\"google\")" -action oauth_act_google
add authentication Policy pol_oauth_okta -rule "HTTP.REQ.HEADER(\"Host\").CONTAINS(\"okta\")" -action oauth_act_okta
add authentication Policy pol_oauth_default -rule "true" -action oauth_act_oidc

# ============================================================================
# OAUTH IDP PROFILE (NetScaler as OAuth Authorization Server)
# ============================================================================
add authentication OAuthIdPProfile oauth_idp_prof -clientID "registered-client-id" -clientSecret "encrypted_client_secret" -redirectURL "https://app.example.com/callback" -issuer "https://ns.example.com" -audience "https://api.example.com" -skewTime 5 -defaultAuthenticationGroup "OAuth_Clients" -refreshInterval 900 -encryptToken ON -signatureAlg RS256 -signatureService ns_oauth_signer -Attribute1 "sub" -Attribute1Expr "AAA.USER.NAME" -Attribute2 "email" -Attribute2Expr "AAA.USER.ATTRIBUTE(\"mail\")" -Attribute3 "groups" -Attribute3Expr "AAA.USER.GROUPS"

# Multiple client profiles
add authentication OAuthIdPProfile oauth_idp_prof_mobile -clientID "mobile-app-client-id" -clientSecret "encrypted_secret" -redirectURL "myapp://callback" -issuer "https://ns.example.com" -audience "https://api.example.com" -grantTypeSAMLBearer ON -sendPassword OFF -refreshInterval 3600

add authentication OAuthIdPProfile oauth_idp_prof_spa -clientID "spa-client-id" -redirectURL "https://spa.example.com/callback" -issuer "https://ns.example.com" -audience "https://api.example.com" -PKCERequired ON -sendPassword OFF

# ============================================================================
# OAUTH IDP POLICIES
# ============================================================================
add authentication OAuthIdPPolicy oauth_idp_pol_default -rule "true" -action oauth_idp_prof
add authentication OAuthIdPPolicy oauth_idp_pol_mobile -rule "HTTP.REQ.HEADER(\"User-Agent\").CONTAINS(\"Mobile\")" -action oauth_idp_prof_mobile
add authentication OAuthIdPPolicy oauth_idp_pol_spa -rule "HTTP.REQ.HEADER(\"X-Requested-With\").EQ(\"XMLHttpRequest\")" -action oauth_idp_prof_spa

# ============================================================================
# AUTHENTICATION VSERVER FOR OAUTH CLIENT
# ============================================================================
add authentication vserver auth_vs_oauth SSL 10.1.1.230 443 -authenticationDomain example.com
add ssl certKey oauth_cert -cert /nsconfig/ssl/oauth.example.com.crt -key /nsconfig/ssl/oauth.example.com.key
bind ssl vserver auth_vs_oauth -certkeyName oauth_cert

# Bind OAuth policies
bind authentication vserver auth_vs_oauth -policy pol_oauth_azure -priority 100 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_oauth -policy pol_oauth_google -priority 200 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_oauth -policy pol_oauth_okta -priority 300 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_oauth -policy pol_oauth_default -priority 1000 -gotoPriorityExpression END

# ============================================================================
# AUTHENTICATION VSERVER FOR OAUTH IDP (Authorization Server)
# ============================================================================
add authentication vserver auth_vs_oauth_idp SSL 10.1.1.231 443 -authenticationDomain example.com
bind ssl vserver auth_vs_oauth_idp -certkeyName oauth_cert

# LDAP backend for user authentication
add authentication ldapAction ldap_act_oauth_backend -serverIP 10.1.2.10 -serverPort 389 -ldapBase "DC=corp,DC=example,DC=com" -ldapBindDn "CN=svc_oauth,OU=Service,DC=corp,DC=example,DC=com" -ldapBindDnPassword "encrypted_password" -ldapLoginName sAMAccountName -groupAttrName memberOf

add authentication Policy pol_ldap_oauth -rule "true" -action ldap_act_oauth_backend

# Bind authentication and IdP policies
bind authentication vserver auth_vs_oauth_idp -policy pol_ldap_oauth -priority 100 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_oauth_idp -policy oauth_idp_pol_mobile -priority 200 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_oauth_idp -policy oauth_idp_pol_spa -priority 300 -gotoPriorityExpression NEXT
bind authentication vserver auth_vs_oauth_idp -policy oauth_idp_pol_default -priority 1000 -gotoPriorityExpression END

# ============================================================================
# API GATEWAY WITH OAUTH TOKEN VALIDATION
# ============================================================================
add lb vserver lb_api_gateway SSL 10.1.1.240 443 -authentication ON -authnVsName auth_vs_oauth
add serviceGroup sg_api_backend HTTP
add server apiserver1 10.10.2.10
add server apiserver2 10.10.2.11
bind serviceGroup sg_api_backend apiserver1 8080
bind serviceGroup sg_api_backend apiserver2 8080
bind lb vserver lb_api_gateway sg_api_backend
bind ssl vserver lb_api_gateway -certkeyName oauth_cert

# ============================================================================
# BEARER TOKEN VALIDATION (For API Access)
# ============================================================================
add authentication OAuthAction oauth_act_bearer_validate -tokenEndpoint "https://ns.example.com/oauth/introspect" -introspectURL "https://ns.example.com/oauth/introspect" -certEndpoint "https://ns.example.com/.well-known/jwks.json" -audience "https://api.example.com" -issuer "https://ns.example.com" -userNameField "sub"

add authentication Policy pol_bearer_validate -rule "HTTP.REQ.HEADER(\"Authorization\").STARTSWITH(\"Bearer \")" -action oauth_act_bearer_validate

# ============================================================================
# SESSION POLICY FOR OAUTH TOKENS
# ============================================================================
add tm sessionAction session_act_oauth -SSO ON -ssoCredential PRIMARY -homepage "/api/user" -persistentCookie ENABLED -persistentCookieValidity 60

add tm sessionPolicy session_pol_oauth "AAA.USER.IS_MEMBER_OF(\"OAuth_Users\") || AAA.USER.IS_MEMBER_OF(\"Azure_Users\")" session_act_oauth

bind lb vserver lb_api_gateway -policyName session_pol_oauth -priority 100 -type REQUEST

# ============================================================================
# TOKEN ENDPOINT RESPONDERS
# ============================================================================
# Token endpoint
add responder action resp_oauth_token respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: application/json\\r\\n\\r\\n{\\\"access_token\\\":\\\"...\\\",\\\"token_type\\\":\\\"Bearer\\\",\\\"expires_in\\\":3600}\""

# JWKS endpoint
add responder action resp_oauth_jwks respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: application/json\\r\\n\\r\\n{\\\"keys\\\":[...]}\""

# OpenID configuration
add responder action resp_oidc_config respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: application/json\\r\\n\\r\\n{\\\"issuer\\\":\\\"https://ns.example.com\\\",\\\"authorization_endpoint\\\":\\\"https://ns.example.com/oauth/authorize\\\",\\\"token_endpoint\\\":\\\"https://ns.example.com/oauth/token\\\"}\""

add responder policy resp_pol_oidc_config "HTTP.REQ.URL.PATH.EQ(\"/.well-known/openid-configuration\")" resp_oidc_config
add responder policy resp_pol_jwks "HTTP.REQ.URL.PATH.EQ(\"/.well-known/jwks.json\")" resp_oauth_jwks

# ============================================================================
# OAUTH SCOPES AND PERMISSIONS (Reference)
# ============================================================================
# Scopes handled via policy expressions:
# - openid: Basic OIDC scope
# - profile: User profile information
# - email: Email address
# - groups: Group membership
# - offline_access: Refresh token
