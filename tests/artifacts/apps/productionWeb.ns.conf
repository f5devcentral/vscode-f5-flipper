#NS13.1 Build 61.23
# Production Web Application - Comprehensive Integration Test
# Purpose: Realistic production config combining multiple features
# Note: Synthetic config for comprehensive parsing validation

# ============================================================================
# SERVERS
# ============================================================================
add server web1 10.10.1.10
add server web2 10.10.1.11
add server web3 10.10.1.12
add server api1 10.10.2.10
add server api2 10.10.2.11
add server static1 10.10.3.10
add server db1 10.10.4.10 -comment "Primary database"
add server db2 10.10.4.11 -comment "Secondary database"

# ============================================================================
# MONITORS
# ============================================================================
add lb monitor http_health HTTP -respCode 200 -httpRequest "GET /health HTTP/1.1\r\nHost: www.example.com\r\n\r\n" -recv "OK" -interval 10 -resptimeout 5
add lb monitor api_health HTTP -respCode 200 -httpRequest "GET /api/health HTTP/1.1\r\nHost: api.example.com\r\nAccept: application/json\r\n\r\n" -recv "\"status\":\"healthy\""
add lb monitor tcp_db TCP -send "PING\r\n" -recv "PONG" -interval 30 -resptimeout 10
add lb monitor https_health HTTP-ECV -secure YES -send "GET /healthz HTTP/1.1\r\nHost: secure.example.com\r\n\r\n" -recv "healthy"

# ============================================================================
# SERVICE GROUPS
# ============================================================================
add serviceGroup sg_web_prod HTTP -maxClient 5000 -maxReq 10000 -usip NO -cip ENABLED X-Forwarded-For
bind serviceGroup sg_web_prod web1 80 -weight 100
bind serviceGroup sg_web_prod web2 80 -weight 100
bind serviceGroup sg_web_prod web3 80 -weight 50
bind serviceGroup sg_web_prod -monitorName http_health

add serviceGroup sg_api_prod HTTP -maxClient 2000 -maxReq 5000
bind serviceGroup sg_api_prod api1 8080 -weight 100
bind serviceGroup sg_api_prod api2 8080 -weight 100
bind serviceGroup sg_api_prod -monitorName api_health

add serviceGroup sg_static HTTP -maxClient 10000
bind serviceGroup sg_static static1 80
bind serviceGroup sg_static -monitorName http_health

add serviceGroup sg_db_ssl SSL -maxClient 100
bind serviceGroup sg_db_ssl db1 3306 -weight 100
bind serviceGroup sg_db_ssl db2 3306 -weight 50
bind serviceGroup sg_db_ssl -monitorName tcp_db

# ============================================================================
# PROFILES
# ============================================================================
# TCP Profile - Optimized for web traffic
add ns tcpProfile tcp_web_optimized -WS ENABLED -SACK ENABLED -nagle DISABLED -mss 1460 -maxBurst 30 -initialCwnd 16 -bufferSize 131072 -flavor BIC -dynamicReceiveBuffering ENABLED

# HTTP Profile - Production settings
add ns httpProfile http_web_optimized -dropInvalReqs ENABLED -markHttp09Inval ENABLED -markConnReqInval ENABLED -maxHeaderLen 24820 -maxReq 100 -minReUsedCon 10 -conMultiplex ENABLED -http2 DISABLED

# HTTP Profile - API with HTTP/2
add ns httpProfile http_api_modern -dropInvalReqs ENABLED -maxHeaderLen 16384 -http2 ENABLED -http2MaxHeaderListSize 32768 -http2MaxFrameSize 16384

# SSL Profile - Frontend (Modern)
add ssl profile ssl_frontend_modern -ssl3 DISABLED -tls1 DISABLED -tls11 DISABLED -tls12 ENABLED -tls13 ENABLED -denySSLReneg ALL -HSTS ENABLED -maxage 31536000 -IncludeSubdomains YES -preload YES -sessReuse ENABLED -sessTimeout 120

# SSL Profile - Backend
add ssl profile ssl_backend -sslProfileType BackEnd -ssl3 DISABLED -tls1 DISABLED -tls11 DISABLED -tls12 ENABLED -sessReuse ENABLED

# DNS Profile
add dns profile dns_prod -dnsQueryLogging ENABLED -cacheRecords ENABLED -cacheNegativeResponses ENABLED

# ============================================================================
# SSL CERTIFICATES
# ============================================================================
add ssl certKey wildcard_cert -cert /nsconfig/ssl/wildcard.example.com.crt -key /nsconfig/ssl/wildcard.example.com.key
add ssl certKey api_cert -cert /nsconfig/ssl/api.example.com.crt -key /nsconfig/ssl/api.example.com.key
add ssl certKey ca_bundle -cert /nsconfig/ssl/ca-bundle.crt

# ============================================================================
# COMPRESSION POLICIES
# ============================================================================
add cmp policy cmp_text -rule "HTTP.RES.HEADER(\"Content-Type\").CONTAINS(\"text\")" -resAction COMPRESS
add cmp policy cmp_json -rule "HTTP.RES.HEADER(\"Content-Type\").CONTAINS(\"json\")" -resAction COMPRESS
add cmp policy cmp_javascript -rule "HTTP.RES.HEADER(\"Content-Type\").CONTAINS(\"javascript\")" -resAction COMPRESS
add cmp policy cmp_nocompress -rule "HTTP.RES.HEADER(\"Content-Encoding\").EXISTS" -resAction NOCOMPRESS

# ============================================================================
# REWRITE POLICIES
# ============================================================================
# Security headers
add rewrite action rw_add_xframe insert_http_header "X-Frame-Options" "\"DENY\""
add rewrite action rw_add_xss insert_http_header "X-XSS-Protection" "\"1; mode=block\""
add rewrite action rw_add_content_type insert_http_header "X-Content-Type-Options" "\"nosniff\""
add rewrite action rw_add_hsts insert_http_header "Strict-Transport-Security" "\"max-age=31536000; includeSubDomains; preload\""
add rewrite action rw_remove_server delete_http_header "Server"
add rewrite action rw_remove_xpowered delete_http_header "X-Powered-By"

add rewrite policy rw_security_xframe "true" rw_add_xframe
add rewrite policy rw_security_xss "true" rw_add_xss
add rewrite policy rw_security_content "true" rw_add_content_type
add rewrite policy rw_security_hsts "true" rw_add_hsts
add rewrite policy rw_strip_server "HTTP.RES.HEADER(\"Server\").EXISTS" rw_remove_server
add rewrite policy rw_strip_xpowered "HTTP.RES.HEADER(\"X-Powered-By\").EXISTS" rw_remove_xpowered

# URL rewrites
add rewrite action rw_trailing_slash replace "HTTP.REQ.URL.PATH" "HTTP.REQ.URL.PATH + \"/\""
add rewrite policy rw_add_trailing_slash "HTTP.REQ.URL.PATH.ENDSWITH(\"/\").NOT && HTTP.REQ.URL.PATH.CONTAINS(\".\").NOT" rw_trailing_slash

# ============================================================================
# RESPONDER POLICIES
# ============================================================================
# HTTPS redirect
add responder action resp_https_redirect redirect "\"https://\" + HTTP.REQ.HOSTNAME + HTTP.REQ.URL" -responseStatusCode 301
add responder policy resp_force_https "HTTP.REQ.IS_VALID && CLIENT.SSL.IS_SSL.NOT" resp_https_redirect

# Maintenance mode
add responder action resp_maintenance respondwith "\"HTTP/1.1 503 Service Unavailable\\r\\nContent-Type: text/html\\r\\n\\r\\n<html><body><h1>Maintenance</h1></body></html>\""
add responder policy resp_maintenance_mode "HTTP.REQ.URL.PATH.STARTSWITH(\"/maintenance\")" resp_maintenance

# Health check bypass
add responder action resp_health_ok respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: text/plain\\r\\n\\r\\nOK\""
add responder policy resp_health_check "HTTP.REQ.URL.PATH.EQ(\"/health\") || HTTP.REQ.URL.PATH.EQ(\"/healthz\")" resp_health_ok

# Block bad bots
add responder action resp_block_bot DROP
add responder policy resp_block_bots "HTTP.REQ.HEADER(\"User-Agent\").CONTAINS(\"curl\") || HTTP.REQ.HEADER(\"User-Agent\").CONTAINS(\"wget\")" resp_block_bot

# ============================================================================
# LOAD BALANCER - HTTP (Redirect to HTTPS)
# ============================================================================
add lb vserver lb_web_http HTTP 10.1.1.100 80 -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized
bind lb vserver lb_web_http -policyName resp_force_https -priority 100 -gotoPriorityExpression END -type REQUEST

# ============================================================================
# LOAD BALANCER - HTTPS (Main Web)
# ============================================================================
add lb vserver lb_web_https SSL 10.1.1.100 443 -persistenceType COOKIEINSERT -cookieName NSPERSIST -timeout 1800 -lbMethod LEASTCONNECTION -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized -backupVServer lb_web_backup
bind lb vserver lb_web_https sg_web_prod
bind ssl vserver lb_web_https -certkeyName wildcard_cert
bind ssl vserver lb_web_https -sslProfile ssl_frontend_modern

# Response policies (compression)
bind lb vserver lb_web_https -policyName cmp_nocompress -priority 90 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName cmp_text -priority 100 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName cmp_json -priority 110 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName cmp_javascript -priority 120 -gotoPriorityExpression END -type RESPONSE

# Response policies (security headers)
bind lb vserver lb_web_https -policyName rw_security_xframe -priority 200 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName rw_security_xss -priority 210 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName rw_security_content -priority 220 -gotoPriorityExpression NEXT -type RESPONSE
bind lb vserver lb_web_https -policyName rw_strip_server -priority 230 -gotoPriorityExpression END -type RESPONSE

# ============================================================================
# LOAD BALANCER - API
# ============================================================================
add lb vserver lb_api_https SSL 10.1.1.101 443 -persistenceType SOURCEIP -timeout 300 -lbMethod ROUNDROBIN -httpProfileName http_api_modern -tcpProfileName tcp_web_optimized
bind lb vserver lb_api_https sg_api_prod
bind ssl vserver lb_api_https -certkeyName api_cert
bind ssl vserver lb_api_https -sslProfile ssl_frontend_modern

# ============================================================================
# LOAD BALANCER - Static Content
# ============================================================================
add lb vserver lb_static_https SSL 10.1.1.102 443 -lbMethod ROUNDROBIN -httpProfileName http_web_optimized
bind lb vserver lb_static_https sg_static
bind ssl vserver lb_static_https -certkeyName wildcard_cert

# ============================================================================
# LOAD BALANCER - Backup
# ============================================================================
add lb vserver lb_web_backup HTTP 10.1.1.200 80 -httpProfileName http_web_optimized

# ============================================================================
# CONTENT SWITCHING - Main Entry Point
# ============================================================================
add cs vserver cs_main_https SSL 10.1.1.50 443 -httpProfileName http_web_optimized -tcpProfileName tcp_web_optimized
bind ssl vserver cs_main_https -certkeyName wildcard_cert
bind ssl vserver cs_main_https -sslProfile ssl_frontend_modern

# CS Actions
add cs action cs_act_api -targetLBVserver lb_api_https
add cs action cs_act_static -targetLBVserver lb_static_https
add cs action cs_act_web -targetLBVserver lb_web_https

# CS Policies
add cs policy cs_pol_api -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/api/\")" -action cs_act_api
add cs policy cs_pol_static -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/static/\") || HTTP.REQ.URL.PATH.ENDSWITH(\".css\") || HTTP.REQ.URL.PATH.ENDSWITH(\".js\") || HTTP.REQ.URL.PATH.ENDSWITH(\".png\") || HTTP.REQ.URL.PATH.ENDSWITH(\".jpg\")" -action cs_act_static
add cs policy cs_pol_default -rule "true" -action cs_act_web

# Bind CS policies
bind cs vserver cs_main_https -policyName cs_pol_api -priority 100
bind cs vserver cs_main_https -policyName cs_pol_static -priority 200
bind cs vserver cs_main_https -policyName cs_pol_default -priority 1000

# Request policies on CS vserver
bind cs vserver cs_main_https -policyName resp_health_check -priority 50 -gotoPriorityExpression END -type REQUEST
bind cs vserver cs_main_https -policyName resp_block_bots -priority 60 -gotoPriorityExpression NEXT -type REQUEST

# ============================================================================
# RATE LIMITING
# ============================================================================
add ns limitSelector limit_sel_client -rule "CLIENT.IP.SRC"
add ns limitSelector limit_sel_url -rule "HTTP.REQ.URL.PATH"
add ns limitIdentifier limit_api_rate -threshold 1000 -timeSlice 60000 -mode REQUEST_RATE -limitType BURSTY -selectorName limit_sel_client
add ns limitIdentifier limit_login_rate -threshold 10 -timeSlice 300000 -mode REQUEST_RATE -limitType SMOOTH -selectorName limit_sel_client

add responder action resp_rate_limit respondwith "\"HTTP/1.1 429 Too Many Requests\\r\\nRetry-After: 60\\r\\n\\r\\n\""
add responder policy resp_api_rate_limit "SYS.CHECK_LIMIT(\"limit_api_rate\")" resp_rate_limit
add responder policy resp_login_rate_limit "HTTP.REQ.URL.PATH.STARTSWITH(\"/login\") && SYS.CHECK_LIMIT(\"limit_login_rate\")" resp_rate_limit

# ============================================================================
# SPILLOVER
# ============================================================================
add spillover policy spill_pol_conns -rule "SYS.VSERVER(\"lb_web_https\").ACTIVECONN.GT(5000)" -action SPILLOVER
set lb vserver lb_web_https -spilloverMethod CONNECTION -spilloverThreshold 5000

# ============================================================================
# CACHE (Optional - requires IC feature)
# ============================================================================
add cache contentGroup static_cache -maxResSize 1000000 -memLimit 268435456 -relExpiry 86400
add cache selector cache_sel_url -rule "HTTP.REQ.URL.PATH"
add cache policy cache_pol_static -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/static/\")" -action CACHE -storeInGroup static_cache

# ============================================================================
# AUDIT LOGGING
# ============================================================================
add audit syslogAction syslog_act -serverIP 10.1.5.50 -serverPort 514 -logLevel ALL -logFacility LOCAL0
add audit syslogPolicy syslog_pol_all -rule "true" -action syslog_act
