#NS13.1 Build 37.38
# Extracted from t1.ns.conf - application/GSLB configs only
# Removed: system settings, encrypted passwords, routes, interface configs

# Servers (IP-based)
add server 1.2.3.4 1.2.3.4
add server 1.2.3.5 1.2.3.5

# Service Group
add serviceGroup app1_http_sg HTTP -maxClient 0 -maxReq 0 -cip DISABLED -usip NO -useproxyport YES -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP NO
bind serviceGroup app1_http_sg 1.2.3.5 80
bind serviceGroup app1_http_sg 1.2.3.4 80
bind serviceGroup app1_http_sg -monitorName app1_http_mon

# Monitor
add lb monitor app1_http_mon HTTP -respCode 200 -httpRequest "GET /index.html" -LRTM DISABLED

# SSL Cert (will need provision_test_certs)
add ssl certKey app1_local -cert foo.crt -key foo.key

# LB Vservers
add lb vserver https_offload_vs SSL 192.168.86.142 443 -persistenceType NONE -cltTimeout 180 -redirectFromPort 80 -httpsRedirectUrl "https://192.168.86.142"
add lb vserver app2_http_vs HTTP 192.168.86.144 80 -persistenceType NONE -cltTimeout 180
bind lb vserver https_offload_vs app1_http_sg
bind lb vserver app2_http_vs app1_http_sg
bind lb vserver app2_http_vs -policyName app2_rewrite_policy -priority 100 -gotoPriorityExpression END -type REQUEST

# SSL bindings for LB vserver
bind ssl vserver https_offload_vs -cipherName ECDHE
bind ssl vserver https_offload_vs -certkeyName app1_local
bind ssl vserver https_offload_vs -eccCurveName P_256
bind ssl vserver https_offload_vs -eccCurveName P_384
bind ssl vserver https_offload_vs -eccCurveName P_224
bind ssl vserver https_offload_vs -eccCurveName P_521

# CS Vserver
add cs vserver app2_cs_vs HTTP 192.168.86.143 443 -cltTimeout 180 -persistenceType NONE
add cs action mycsaction -targetLBVserver https_offload_vs -comment "Forwards requests to mylbvserver."
add cs policy policy-CS-4 -rule "HTTP.REQ.HOSTNAME.EQ(\"app2.com\")" -action mycsaction
bind cs vserver app2_cs_vs -policyName policy-CS-4 -priority 100
bind cs vserver app2_cs_vs -lbvserver https_offload_vs

# Rewrite policy/action
add rewrite action app2_rewrite_pol insert_http_header app2header "HTTP.REQ.HEADER(\"app2header\").CONTAINS(\"somestring\")"
add rewrite policy app2_rewrite_policy HTTP.REQ.IS_VALID app2_rewrite_pol

### GSLB Configuration -------------------------------------------------------

# GSLB Sites (sitePassword required for MEP - using dummy for config testing)
add gslb site nedc-gslb-site 10.8.96.1 -publicIP 10.8.96.1 -sitePassword nsroot
add gslb site swdc-gslb-site 10.12.96.1 -publicIP 10.12.96.1 -sitePassword nsroot

# GSLB Servers
add server ctx1-swdc 10.5.7.2
add server ctx1-nedc 10.56.4.2
add server smtp-swdc 10.5.7.1
add server smtp-nedc 10.56.4.1
add server trout-nedc 10.56.4.10
add server trout-swdc 10.5.7.10
add server bottle-swdc 10.5.7.25
add server bottle-nedc 10.56.4.25
add server echo-nedc 10.8.103.249
add server echo-swdc 10.12.103.249
add server dorsal-nedc 10.8.101.46 -comment "automated deployment"
add server dorsal-swdc 10.12.101.46 -comment "automated deployment"

# GSLB VServer: ctx1.gslb.f5flipper.com (SSL)
add gslb vserver ctx1.gslb.f5flipper.com HTTP -backupLBMethod ROUNDROBIN -tolerance 0 -appflowLog DISABLED
bind gslb vserver ctx1.gslb.f5flipper.com -domainName ctx1.gslb.f5flipper.com -TTL 5
add gslb service ctx1-nedc-gslb ctx1-nedc SSL 443 -publicIP 10.56.4.2 -publicPort 443 -maxClient 0 -siteName nedc-gslb-site -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED
add gslb service ctx1-swdc-gslb ctx1-swdc SSL 443 -publicIP 10.5.7.2 -publicPort 443 -maxClient 0 -siteName swdc-gslb-site -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED
bind gslb vserver ctx1.gslb.f5flipper.com -serviceName ctx1-nedc-gslb
bind gslb vserver ctx1.gslb.f5flipper.com -serviceName ctx1-swdc-gslb

# GSLB VServer: smtp.gslb.f5flipper.com (TCP)
add gslb vserver smtp.gslb.f5flipper.com TCP -backupLBMethod ROUNDROBIN -tolerance 0 -appflowLog DISABLED
bind gslb vserver smtp.gslb.f5flipper.com -domainName smtp.gslb.f5flipper.com -TTL 5
add gslb service smtp-swdc-gslb smtp-swdc TCP 25 -publicIP 10.5.7.1 -publicPort 25 -maxClient 0 -siteName swdc-gslb-site -cltTimeout 9000 -svrTimeout 9000 -downStateFlush DISABLED
add gslb service smtp-nedc-gslb smtp-nedc TCP 25 -publicIP 10.56.4.1 -publicPort 25 -maxClient 0 -siteName nedc-gslb-site -cltTimeout 9000 -svrTimeout 9000 -downStateFlush DISABLED
bind gslb vserver smtp.gslb.f5flipper.com -serviceName smtp-nedc-gslb
bind gslb vserver smtp.gslb.f5flipper.com -serviceName smtp-swdc-gslb

# GSLB Services for trout (no vserver in original - orphaned?)
add gslb service trout-swdc-gslb trout-swdc HTTP 80 -publicIP 10.5.7.10 -publicPort 80 -maxClient 0 -siteName swdc-gslb-site -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED
add gslb service trout-nedc-gslb trout-nedc HTTP 80 -publicIP 10.56.4.10 -publicPort 80 -maxClient 0 -siteName nedc-gslb-site -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED

# GSLB VServer: bottle.gslb.f5flipper.com (TCP)
add gslb vserver bottle.gslb.f5flipper.com TCP -backupLBMethod ROUNDROBIN -tolerance 0 -appflowLog DISABLED
bind gslb vserver bottle.gslb.f5flipper.com -domainName bottle.gslb.f5flipper.com -TTL 5
add gslb service bottle-swdc-gslb bottle-swdc TCP 50607 -publicIP 10.5.7.25 -publicPort 50607 -maxClient 0 -siteName swdc-gslb-site -cltTimeout 9000 -svrTimeout 9000 -downStateFlush DISABLED
add gslb service bottle-nedc-gslb bottle-nedc TCP 50607 -publicIP 10.56.4.25 -publicPort 50607 -maxClient 0 -siteName nedc-gslb-site -cltTimeout 9000 -svrTimeout 9000 -downStateFlush DISABLED
bind gslb vserver bottle.gslb.f5flipper.com -serviceName bottle-nedc-gslb
bind gslb vserver bottle.gslb.f5flipper.com -serviceName bottle-swdc-gslb

# GSLB VServer: echo.gslb.f5flipper.com (HTTP, LEASTBANDWIDTH)
add gslb vserver echo.gslb.f5flipper.com HTTP -lbMethod LEASTBANDWIDTH -backupLBMethod ROUNDROBIN -tolerance 0 -appflowLog DISABLED
bind gslb vserver echo.gslb.f5flipper.com -domainName echo.gslb.f5flipper.com -TTL 5
bind gslb vserver echo.gslb.f5flipper.com -domainName echo.f5flipper.com -TTL 5
add gslb service echo-nedc-gslb echo-nedc HTTP 80 -publicIP 10.8.103.249 -publicPort 80 -maxClient 0 -siteName nedc-gslb-site -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED
add gslb service echo-swdc-gslb echo-swdc HTTP 80 -publicIP 10.12.103.249 -publicPort 80 -maxClient 0 -siteName swdc-gslb-site -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED
bind gslb vserver echo.gslb.f5flipper.com -serviceName echo-nedc-gslb
bind gslb vserver echo.gslb.f5flipper.com -serviceName echo-swdc-gslb

# GSLB VServer: dorsal.gslb.f5flipper.com (SSL)
add gslb vserver dorsal.gslb.f5flipper.com SSL -backupLBMethod ROUNDROBIN -tolerance 0 -comment "automated deployment" -appflowLog DISABLED
bind gslb vserver dorsal.gslb.f5flipper.com -domainName dorsal -TTL 5
bind gslb vserver dorsal.gslb.f5flipper.com -domainName dorsal.f5flipper.com -TTL 5
bind gslb vserver dorsal.gslb.f5flipper.com -domainName dorsal.gslb.f5flipper.com -TTL 5
add gslb service dorsal-nedc-gslb dorsal-nedc SSL 443 -publicIP 10.8.101.46 -publicPort 443 -maxClient 0 -siteName nedc-gslb-site -cip ENABLED X-Forwarded-For -sitePersistence ConnectionProxy -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED -comment "automated deployment"
add gslb service dorsal-swdc-gslb dorsal-swdc SSL 443 -publicIP 10.12.101.46 -publicPort 443 -maxClient 0 -siteName swdc-gslb-site -cip ENABLED X-Forwarded-For -sitePersistence ConnectionProxy -cltTimeout 180 -svrTimeout 360 -downStateFlush DISABLED -comment "automated deployment"
bind gslb vserver dorsal.gslb.f5flipper.com -serviceName dorsal-nedc-gslb
bind gslb vserver dorsal.gslb.f5flipper.com -serviceName dorsal-swdc-gslb

### STP LB Application (from GSLB section but is local LB) -------------------

# Servers (converted from DNS names to IPs - originals were hostnames)
add server stpvea1 10.5.10.41 -comment "automated deployment"
add server stpvea2 10.5.10.42 -comment "automated deployment"
add server stpvec1 10.5.10.43 -comment "automated deployment"
add server stpvec2 10.5.10.44 -comment "automated deployment"

# Services
add service stpvec2-7084-service stpvec2 SSL 7084 -gslb NONE -maxClient 0 -maxReq 0 -cip ENABLED X-Forwarded-For -usip NO -useproxyport YES -sp OFF -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP YES -comment "automated deployment"
add service stpvec1-7084-service stpvec1 SSL 7084 -gslb NONE -maxClient 0 -maxReq 0 -cip ENABLED X-Forwarded-For -usip NO -useproxyport YES -sp OFF -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP YES -comment "automated deployment"
add service stpvea2-7084-service stpvea2 SSL 7084 -gslb NONE -maxClient 0 -maxReq 0 -cip ENABLED X-Forwarded-For -usip NO -useproxyport YES -sp OFF -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP YES -comment "automated deployment"
add service stpvea1-7084-service stpvea1 SSL 7084 -gslb NONE -maxClient 0 -maxReq 0 -cip ENABLED X-Forwarded-For -usip NO -useproxyport YES -sp OFF -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP YES -comment "automated deployment"
bind service stpvea1-7084-service -monitorName https
bind service stpvea2-7084-service -monitorName https
bind service stpvec1-7084-service -monitorName https
bind service stpvec2-7084-service -monitorName https

# LB Vservers for STP
add lb vserver stp.gslb.f5flipper.com-http-vs-failover HTTP 0.0.0.0 0 -persistenceType COOKIEINSERT -timeout 0 -cltTimeout 180 -comment "automated deployment"
add lb vserver stp.gslb.f5flipper.com-http-vs HTTP 10.5.10.33 80 -persistenceType COOKIEINSERT -timeout 0 -cltTimeout 180 -backupVServer stp.gslb.f5flipper.com-http-vs-failover -comment "automated deployment"
add lb vserver stp.gslb.f5flipper.com-ssl-vs-failover SSL 0.0.0.0 0 -persistenceType COOKIEINSERT -timeout 0 -cltTimeout 180 -comment "automated deployment"
add lb vserver stp.gslb.f5flipper.com-ssl-vs SSL 10.5.10.33 443 -persistenceType COOKIEINSERT -timeout 0 -cltTimeout 180 -backupVServer stp.gslb.f5flipper.com-ssl-vs-failover -comment "automated deployment"
bind lb vserver stp.gslb.f5flipper.com-http-vs-failover stpvea2-7084-service
bind lb vserver stp.gslb.f5flipper.com-http-vs-failover stpvea1-7084-service
bind lb vserver stp.gslb.f5flipper.com-http-vs stpvec1-7084-service
bind lb vserver stp.gslb.f5flipper.com-http-vs stpvec2-7084-service
bind lb vserver stp.gslb.f5flipper.com-ssl-vs-failover stpvea2-7084-service
bind lb vserver stp.gslb.f5flipper.com-ssl-vs-failover stpvea1-7084-service
bind lb vserver stp.gslb.f5flipper.com-ssl-vs stpvec1-7084-service
bind lb vserver stp.gslb.f5flipper.com-ssl-vs stpvec2-7084-service

# Rewrite policies for STP SSL header insertion
add rewrite action del_x_ns_ssl delete_http_header X-NS-SSL
add rewrite action insert_x_ns_ssl insert_http_header X-NS-SSL "\"true\""
add rewrite policy check_x_ns_ssl_policy "HTTP.REQ.HEADER(\"X-NS-SSL\").EXISTS" del_x_ns_ssl
add rewrite policy insert_x_ns_ssl_policy CLIENT.SSL.IS_SSL insert_x_ns_ssl
bind lb vserver stp.gslb.f5flipper.com-ssl-vs-failover -policyName check_x_ns_ssl_policy -priority 100 -gotoPriorityExpression 200 -type REQUEST
bind lb vserver stp.gslb.f5flipper.com-ssl-vs-failover -policyName insert_x_ns_ssl_policy -priority 200 -gotoPriorityExpression END -type REQUEST
