#NS13.1 Build 61.23
# nFactor Authentication Configuration
# Purpose: Test nFactor/multi-factor authentication parsing
# Note: Synthetic config - Authentication feature detection reference

# ============================================================================
# LOGIN SCHEMAS
# ============================================================================
# Single factor login schema
add authentication loginSchema lschema_single -authenticationSchema "/nsconfig/loginschema/LoginSchema/SingleAuth.xml"

# Dual factor login schema
add authentication loginSchema lschema_dual -authenticationSchema "/nsconfig/loginschema/LoginSchema/DualAuth.xml" -passwdExpression "AAA.LOGIN.PASSWORD2"

# Username only schema (for first factor)
add authentication loginSchema lschema_username -authenticationSchema "/nsconfig/loginschema/LoginSchema/OnlyUsername.xml"

# Password only schema (for second factor)
add authentication loginSchema lschema_password -authenticationSchema "/nsconfig/loginschema/LoginSchema/OnlyPassword.xml"

# Custom schema with factor sequence
add authentication loginSchema lschema_custom -authenticationSchema "/nsconfig/loginschema/custom_schema.xml" -userExpression "HTTP.REQ.HEADER(\"X-User\")" -passwdExpression "HTTP.REQ.HEADER(\"X-Password\")"

# No-schema (for API authentication)
add authentication loginSchema lschema_noschema -authenticationSchema noschema

# ============================================================================
# LOGIN SCHEMA POLICIES
# ============================================================================
add authentication loginSchemaPolicy lschemapol_default -rule "true" -action lschema_single
add authentication loginSchemaPolicy lschemapol_mfa -rule "HTTP.REQ.HEADER(\"X-MFA-Required\").EXISTS" -action lschema_dual
add authentication loginSchemaPolicy lschemapol_api -rule "HTTP.REQ.URL.PATH.STARTSWITH(\"/api/\")" -action lschema_noschema

# ============================================================================
# LDAP AUTHENTICATION ACTIONS
# ============================================================================
# Primary LDAP - Active Directory
add authentication ldapAction ldap_act_primary -serverIP 10.1.2.10 -serverPort 389 -ldapBase "DC=corp,DC=example,DC=com" -ldapBindDn "CN=svc_auth,OU=ServiceAccounts,DC=corp,DC=example,DC=com" -ldapBindDnPassword "encrypted_password" -ldapLoginName sAMAccountName -groupAttrName memberOf -subAttributeName CN -secType PLAINTEXT -authentication ENABLED -passwdChange ENABLED

# Secondary LDAP - Failover
add authentication ldapAction ldap_act_secondary -serverIP 10.1.2.11 -serverPort 389 -ldapBase "DC=corp,DC=example,DC=com" -ldapBindDn "CN=svc_auth,OU=ServiceAccounts,DC=corp,DC=example,DC=com" -ldapBindDnPassword "encrypted_password" -ldapLoginName sAMAccountName -secType PLAINTEXT

# LDAPS (Secure LDAP)
add authentication ldapAction ldap_act_secure -serverIP 10.1.2.10 -serverPort 636 -ldapBase "DC=corp,DC=example,DC=com" -ldapBindDn "CN=svc_auth,OU=ServiceAccounts,DC=corp,DC=example,DC=com" -ldapBindDnPassword "encrypted_password" -ldapLoginName sAMAccountName -secType SSL -validateServerCert YES

# LDAP for group extraction only
add authentication ldapAction ldap_act_groups -serverIP 10.1.2.10 -serverPort 389 -ldapBase "DC=corp,DC=example,DC=com" -ldapBindDn "CN=svc_auth,OU=ServiceAccounts,DC=corp,DC=example,DC=com" -ldapBindDnPassword "encrypted_password" -ldapLoginName sAMAccountName -groupAttrName memberOf -subAttributeName CN -authentication DISABLED

# ============================================================================
# LDAP AUTHENTICATION POLICIES
# ============================================================================
add authentication Policy pol_ldap_primary -rule "true" -action ldap_act_primary
add authentication Policy pol_ldap_secondary -rule "AAA.LOGIN.DOMAIN.EQ(\"secondary\")" -action ldap_act_secondary
add authentication Policy pol_ldap_secure -rule "CLIENT.SSL.IS_SSL" -action ldap_act_secure
add authentication Policy pol_ldap_groups -rule "true" -action ldap_act_groups

# ============================================================================
# RADIUS AUTHENTICATION (MFA Second Factor)
# ============================================================================
add authentication radiusAction radius_act_mfa -serverIP 10.1.2.20 -serverPort 1812 -radKey "shared_secret_key" -radNASip ENABLED -radAttributeType 11 -passEncoding pap -accounting ON

add authentication radiusAction radius_act_push -serverIP 10.1.2.21 -serverPort 1812 -radKey "shared_secret" -radNASip ENABLED -callingstationid ENABLED -authTimeout 60

add authentication Policy pol_radius_mfa -rule "true" -action radius_act_mfa
add authentication Policy pol_radius_push -rule "AAA.LOGIN.VALUE(\"auth_method\").EQ(\"push\")" -action radius_act_push

# ============================================================================
# CERTIFICATE AUTHENTICATION
# ============================================================================
add authentication certAction cert_act_client -twoFactor ON -userNameField Subject:CN -groupNameField Subject:OU

add authentication Policy pol_cert -rule "CLIENT.SSL.CLIENT_CERT.EXISTS" -action cert_act_client

# ============================================================================
# NEGOTIATE (KERBEROS) AUTHENTICATION
# ============================================================================
add authentication negotiateAction negotiate_act_krb -domain CORP.EXAMPLE.COM -domainUser svc_krb -domainUserPasswd "encrypted_password" -NTLMPath "/var/nslog/ntlm.log" -defaultAuthenticationGroup "Domain Users"

add authentication Policy pol_negotiate -rule "HTTP.REQ.HEADER(\"Authorization\").STARTSWITH(\"Negotiate\")" -action negotiate_act_krb

# ============================================================================
# LOCAL AUTHENTICATION (Fallback)
# ============================================================================
add authentication localPolicy pol_local -rule "AAA.LOGIN.DOMAIN.EQ(\"local\")" NOACTION

# ============================================================================
# POLICY LABELS (nFactor Chain Nodes)
# ============================================================================
# First factor - LDAP
add authentication policylabel plabel_factor1 -loginSchema lschema_username
bind authentication policylabel plabel_factor1 -policyName pol_ldap_primary -priority 100 -gotoPriorityExpression NEXT -nextFactor plabel_factor2

# Second factor - RADIUS MFA
add authentication policylabel plabel_factor2 -loginSchema lschema_password
bind authentication policylabel plabel_factor2 -policyName pol_radius_mfa -priority 100 -gotoPriorityExpression END

# Alternative MFA path - Push notification
add authentication policylabel plabel_push -loginSchema NOSCHEMA
bind authentication policylabel plabel_push -policyName pol_radius_push -priority 100 -gotoPriorityExpression END

# Certificate + LDAP chain
add authentication policylabel plabel_cert_ldap -loginSchema NOSCHEMA
bind authentication policylabel plabel_cert_ldap -policyName pol_cert -priority 100 -gotoPriorityExpression NEXT -nextFactor plabel_ldap_groups
add authentication policylabel plabel_ldap_groups -loginSchema NOSCHEMA
bind authentication policylabel plabel_ldap_groups -policyName pol_ldap_groups -priority 100 -gotoPriorityExpression END

# ============================================================================
# AUTHENTICATION VIRTUAL SERVER
# ============================================================================
add authentication vserver auth_vs SSL 10.1.1.200 443 -authenticationDomain example.com

# SSL bindings for auth vserver
add ssl certKey auth_cert -cert /nsconfig/ssl/auth.example.com.crt -key /nsconfig/ssl/auth.example.com.key
bind ssl vserver auth_vs -certkeyName auth_cert

# Login schema policy binding
bind authentication vserver auth_vs -policy lschemapol_default -priority 100 -gotoPriorityExpression END

# nFactor flow binding (start with first factor)
bind authentication vserver auth_vs -policy pol_ldap_primary -priority 100 -nextFactor plabel_factor2 -gotoPriorityExpression NEXT

# Alternative flows
bind authentication vserver auth_vs -policy pol_cert -priority 50 -nextFactor plabel_ldap_groups -gotoPriorityExpression END

# ============================================================================
# AAA GROUPS
# ============================================================================
add aaa group Admins -logLevel ALERT
add aaa group Users -logLevel INFO
add aaa group Developers -weight 50

# ============================================================================
# SESSION POLICIES
# ============================================================================
add tm sessionAction session_act_default -SSO ON -ssoCredential PRIMARY -ssoDomain example.com -httpOnlyCookie YES -persistentCookie ENABLED -persistentCookieValidity 1440

add tm sessionPolicy session_pol_default "true" session_act_default

# ============================================================================
# TRAFFIC ACTIONS (SSO)
# ============================================================================
add tm trafficAction traffic_act_sso -SSO ON -persistentCookie ON -InitiateLogout OFF -kcdAccount kcd_account

add tm trafficPolicy traffic_pol_sso "HTTP.REQ.URL.PATH.STARTSWITH(\"/app/\")" traffic_act_sso

# ============================================================================
# KCD (Kerberos Constrained Delegation)
# ============================================================================
add aaa kcdAccount kcd_account -realmStr CORP.EXAMPLE.COM -delegatedUser svc_kcd -kcdPassword "encrypted_password" -serviceSPN "HTTP/app.corp.example.com"

# ============================================================================
# SAMPLE APPLICATION VSERVER WITH AUTH
# ============================================================================
add lb vserver lb_app_auth SSL 10.1.1.100 443 -authentication ON -authn401 OFF -authnVsName auth_vs
add serviceGroup sg_app HTTP
add server appserver1 10.10.1.10
add server appserver2 10.10.1.11
bind serviceGroup sg_app appserver1 8080
bind serviceGroup sg_app appserver2 8080
bind lb vserver lb_app_auth sg_app

# Bind session and traffic policies
bind lb vserver lb_app_auth -policyName session_pol_default -priority 100 -type REQUEST
bind lb vserver lb_app_auth -policyName traffic_pol_sso -priority 100 -gotoPriorityExpression END -type REQUEST
