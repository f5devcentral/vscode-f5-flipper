#NS13.1 Build 61.23
# Special Characters and Edge Cases Configuration
# Purpose: Test parsing edge cases with quoting, special chars, and complex expressions
# Note: Synthetic config for parser robustness testing

# ============================================================================
# NAMES WITH SPACES (Quoted)
# ============================================================================
add lb vserver "Web App Server" HTTP 10.1.1.100 80
add lb vserver "API Gateway v2.0" HTTP 10.1.1.101 80
add server "Backend Server 1" 10.10.1.10
add server "Backend Server 2" 10.10.1.11
add serviceGroup "Production Web Pool" HTTP
bind serviceGroup "Production Web Pool" "Backend Server 1" 80
bind serviceGroup "Production Web Pool" "Backend Server 2" 80
bind lb vserver "Web App Server" "Production Web Pool"

# ============================================================================
# NAMES WITH SPECIAL CHARACTERS
# ============================================================================
add server backend-server_01.example.com 10.10.1.20
add server backend_server-02.internal 10.10.1.21
add serviceGroup sg_app-prod_v2.1 HTTP
add serviceGroup sg_api-backend_tier1 HTTP
bind serviceGroup sg_app-prod_v2.1 backend-server_01.example.com 80
bind serviceGroup sg_api-backend_tier1 backend_server-02.internal 8080

# ============================================================================
# NAMES WITH NUMBERS AND PREFIXES
# ============================================================================
add lb vserver 01_primary_web HTTP 10.1.1.110 80
add lb vserver vs_2024_q1_release HTTP 10.1.1.111 80
add server srv_10.20.30.40 10.20.30.40
add server srv-192-168-1-100 192.168.1.100

# ============================================================================
# COMPLEX QUOTING IN EXPRESSIONS
# ============================================================================
# JSON response with escaped quotes
add responder action resp_json_simple respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: application/json\\r\\n\\r\\n{\\\"status\\\":\\\"ok\\\"}\""

# JSON with multiple fields
add responder action resp_json_complex respondwith "\"HTTP/1.1 200 OK\\r\\nContent-Type: application/json\\r\\n\\r\\n{\\\"status\\\":\\\"healthy\\\",\\\"version\\\":\\\"1.0.0\\\",\\\"timestamp\\\":12345}\""

# HTML response
add responder action resp_html respondwith "\"HTTP/1.1 503 Service Unavailable\\r\\nContent-Type: text/html\\r\\n\\r\\n<html><head><title>Maintenance</title></head><body><h1>Under Maintenance</h1><p>Please try again later.</p></body></html>\""

# Redirect with query parameters
add responder action resp_redirect_params redirect "\"https://new.example.com\" + HTTP.REQ.URL.PATH + \"?source=redirect&original=\" + HTTP.REQ.URL.QUERY.AFTER_STR(\"=\")"

# ============================================================================
# REWRITE WITH REGEX PATTERNS
# ============================================================================
# Clean multiple slashes
add rewrite action rw_clean_slashes replace "HTTP.REQ.URL.PATH" "HTTP.REQ.URL.PATH.REGEX_SELECT(re#/+#).REPLACE_ALL(\"/\", \"/\")"

# Extract and modify URL parts
add rewrite action rw_version_strip replace "HTTP.REQ.URL.PATH" "HTTP.REQ.URL.PATH.REGEX_SELECT(re#/v[0-9]+#).AFTER_REGEX(re#/v[0-9]+#)"

# Case-insensitive matching
add rewrite action rw_lowercase replace "HTTP.REQ.URL.PATH" "HTTP.REQ.URL.PATH.TO_LOWER"

# Policy with complex regex
add rewrite policy rw_pol_clean "HTTP.REQ.URL.PATH.REGEX_MATCH(re#//+#)" rw_clean_slashes
add rewrite policy rw_pol_version "HTTP.REQ.URL.PATH.REGEX_MATCH(re#^/v[0-9]+/.*$#)" rw_version_strip

# ============================================================================
# CACHE RULES WITH COMPLEX EXPRESSIONS
# ============================================================================
add cache policy cache_complex_and -rule "HTTP.REQ.URL.PATH.CONTAINS(\"/static/\") && !HTTP.REQ.URL.QUERY.EXISTS && HTTP.REQ.METHOD.EQ(GET)" -action CACHE
add cache policy cache_complex_or -rule "HTTP.REQ.URL.PATH.ENDSWITH(\".css\") || HTTP.REQ.URL.PATH.ENDSWITH(\".js\") || HTTP.REQ.URL.PATH.ENDSWITH(\".png\")" -action CACHE
add cache policy cache_nested -rule "(HTTP.REQ.URL.PATH.STARTSWITH(\"/assets/\") && HTTP.RES.STATUS.EQ(200)) || HTTP.REQ.URL.PATH.STARTSWITH(\"/cdn/\")" -action CACHE

# ============================================================================
# RESPONDER WITH HEADER MANIPULATION
# ============================================================================
# Headers with colons
add responder action resp_cors respondwith "\"HTTP/1.1 200 OK\\r\\nAccess-Control-Allow-Origin: *\\r\\nAccess-Control-Allow-Methods: GET, POST, OPTIONS\\r\\nAccess-Control-Allow-Headers: Content-Type, Authorization\\r\\n\\r\\n\""

# Multiple Set-Cookie headers
add responder action resp_cookies respondwith "\"HTTP/1.1 200 OK\\r\\nSet-Cookie: session=abc123; Path=/; Secure; HttpOnly\\r\\nSet-Cookie: tracking=xyz789; Path=/; Max-Age=86400\\r\\n\\r\\n\""

# ============================================================================
# PI EXPRESSIONS WITH SPECIAL FUNCTIONS
# ============================================================================
# Client IP operations
add responder policy resp_localhost "CLIENT.IP.SRC.EQ(127.0.0.1) || CLIENT.IP.SRC.IN_SUBNET(10.0.0.0/8)" NOOP

# Time-based rules
add responder policy resp_business_hours "SYS.TIME.WITHIN(\"09:00:00\", \"17:00:00\") && SYS.TIME.DAY.NE(\"SATURDAY\") && SYS.TIME.DAY.NE(\"SUNDAY\")" NOOP

# Header existence and value checks
add responder policy resp_auth_check "HTTP.REQ.HEADER(\"Authorization\").EXISTS && HTTP.REQ.HEADER(\"Authorization\").STARTSWITH(\"Bearer \")" NOOP

# URL encoding/decoding
add rewrite action rw_decode_url replace "HTTP.REQ.URL.PATH" "HTTP.REQ.URL.PATH.DECODE_USING(\"URL\")"
add rewrite policy rw_pol_decode "HTTP.REQ.URL.PATH.CONTAINS(\"%\")" rw_decode_url

# ============================================================================
# COMMENTS AND MIXED CONTENT
# ============================================================================
add server web_primary 10.10.1.50 -comment "Primary web server - DC1"
add server web_secondary 10.10.1.51 -comment "Secondary web server - DC1, failover target"
add server web_dr 10.10.2.50 -comment "DR site server - use only during failover"

# Server with state and comments
add server maintenance_server 10.10.1.99 -state DISABLED -comment "Reserved for maintenance testing"

# ============================================================================
# UNICODE AND INTERNATIONAL (Where Supported)
# ============================================================================
# Note: NetScaler typically uses ASCII, but testing edge cases
add lb vserver lb_intl HTTP 10.1.1.200 80 -comment "International site"

# ============================================================================
# EMPTY AND BOUNDARY VALUES
# ============================================================================
add lb vserver lb_no_port HTTP 10.1.1.201 0
add lb vserver lb_wildcard HTTP 0.0.0.0 80
add lb vserver lb_any_any ANY 0.0.0.0 0

# Very long names (testing limits)
add server server_with_a_very_long_name_that_approaches_netscaler_limits_for_testing 10.10.1.99

# ============================================================================
# BIND STATEMENTS WITH COMPLEX PRIORITIES
# ============================================================================
add lb vserver lb_policy_test HTTP 10.1.1.210 80
add responder policy resp_p1 "true" NOOP
add responder policy resp_p2 "true" NOOP
add responder policy resp_p3 "true" NOOP

bind lb vserver lb_policy_test -policyName resp_p1 -priority 100 -gotoPriorityExpression NEXT -type REQUEST
bind lb vserver lb_policy_test -policyName resp_p2 -priority 200 -gotoPriorityExpression "NEXT + 100" -type REQUEST
bind lb vserver lb_policy_test -policyName resp_p3 -priority 300 -gotoPriorityExpression END -type REQUEST

# ============================================================================
# SSL WITH SPECIAL PATHS
# ============================================================================
add ssl certKey cert_special -cert "/nsconfig/ssl/certs/wildcard.example.com.crt" -key "/nsconfig/ssl/keys/wildcard.example.com.key"
add ssl certKey cert_chain -cert "/nsconfig/ssl/ca-bundle.crt" -inform PEM

# ============================================================================
# MONITORS WITH SPECIAL STRINGS
# ============================================================================
add lb monitor mon_json HTTP -respCode 200 -httpRequest "GET /api/health HTTP/1.1\r\nHost: api.example.com\r\nAccept: application/json\r\n\r\n" -recv "\"status\":\"healthy\""
add lb monitor mon_xml HTTP -respCode 200 -httpRequest "GET /api/status HTTP/1.1\r\nHost: api.example.com\r\nAccept: application/xml\r\n\r\n" -recv "<status>ok</status>"
add lb monitor mon_special_chars TCP -send "GET /?query=test&param=value HTTP/1.0\r\n\r\n" -recv "200"
