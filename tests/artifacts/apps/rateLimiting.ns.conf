# Section 1.7: Rate Limiting
# Tests: ns limitSelector, ns limitIdentifier, responder integration

# Stream Selectors (ns limitSelector is deprecated, use stream selector)
add stream selector limit_sel_client CLIENT.IP.SRC
add stream selector limit_sel_url HTTP.REQ.URL.PATH

# Limit Identifiers (rate limits)
add ns limitIdentifier limit_api_calls -threshold 1000 -timeSlice 60000 -mode REQUEST_RATE -limitType BURSTY
add ns limitIdentifier limit_login -threshold 10 -timeSlice 60000 -mode REQUEST_RATE -limitType SMOOTH -selectorName limit_sel_client

# Responder action for rate limiting
add responder action act_rate_limit respondwith "\"HTTP/1.1 429 Too Many Requests\\r\\nContent-Type: text/plain\\r\\n\\r\\nRate limit exceeded\""
add responder policy pol_rate_limit "SYS.CHECK_LIMIT(\"limit_api_calls\")" act_rate_limit

# Backend and vserver
add server rate_server 10.10.10.50
add serviceGroup sg_rate HTTP
bind serviceGroup sg_rate rate_server 80
add lb vserver vs_rate HTTP 10.1.1.130 80
bind lb vserver vs_rate sg_rate

# Bind responder policy to vserver
bind lb vserver vs_rate -policyName pol_rate_limit -priority 100 -gotoPriorityExpression END -type REQUEST
