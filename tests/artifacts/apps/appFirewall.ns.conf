#NS13.1 Build 61.23
# Application Firewall (AppFW/WAF) Configuration
# Purpose: Test AppFW parsing and feature detection
# Note: Synthetic config - AppFW feature not enabled on test appliance

# == Enable AppFW Feature ==
enable ns feature AppFw

# == AppFW Profile - Strict Security ==
add appfw profile appfw_prof_strict -defaults advanced -type HTML
set appfw profile appfw_prof_strict -startURLAction log block stats
set appfw profile appfw_prof_strict -denyURLAction log block stats
set appfw profile appfw_prof_strict -SQLInjectionAction log block stats
set appfw profile appfw_prof_strict -SQLInjectionType SQLSplCharANDKeyword
set appfw profile appfw_prof_strict -crossSiteScriptingAction log block stats
set appfw profile appfw_prof_strict -crossSiteScriptingTransformUnsafeHTML ON
set appfw profile appfw_prof_strict -CSRFtagAction log block stats
set appfw profile appfw_prof_strict -fieldConsistencyAction log block stats
set appfw profile appfw_prof_strict -bufferOverflowAction log block stats
set appfw profile appfw_prof_strict -bufferOverflowMaxURLLength 2048
set appfw profile appfw_prof_strict -bufferOverflowMaxHeaderLength 8192
set appfw profile appfw_prof_strict -bufferOverflowMaxCookieLength 4096
set appfw profile appfw_prof_strict -cookieConsistencyAction log
set appfw profile appfw_prof_strict -creditCardAction log block stats
set appfw profile appfw_prof_strict -creditCard visa mastercard amex
set appfw profile appfw_prof_strict -creditCardMaxAllowed 0
set appfw profile appfw_prof_strict -creditCardXOut ON

# == AppFW Profile - Relaxed (Learning Mode) ==
add appfw profile appfw_prof_learning -defaults basic -type HTML
set appfw profile appfw_prof_learning -startURLAction log stats
set appfw profile appfw_prof_learning -SQLInjectionAction log stats
set appfw profile appfw_prof_learning -crossSiteScriptingAction log stats
set appfw profile appfw_prof_learning -learning ON
set appfw profile appfw_prof_learning -logEveryPolicyHit ON

# == AppFW Profile - JSON API ==
add appfw profile appfw_prof_api -defaults basic -type JSON
set appfw profile appfw_prof_api -JSONSQLInjectionAction log block stats
set appfw profile appfw_prof_api -JSONSQLInjectionType SQLKeyword
set appfw profile appfw_prof_api -JSONXssAction log block stats
set appfw profile appfw_prof_api -JSONDosAction log block stats
set appfw profile appfw_prof_api -postBodyLimit 10000000
set appfw profile appfw_prof_api -postBodyLimitAction log block stats

# == AppFW Profile - XML Services ==
add appfw profile appfw_prof_xml -defaults basic -type XML
set appfw profile appfw_prof_xml -XMLSQLInjectionAction log block stats
set appfw profile appfw_prof_xml -XMLXSSAction log block stats
set appfw profile appfw_prof_xml -XMLValidationAction log block stats
set appfw profile appfw_prof_xml -XMLDosAction log block stats
set appfw profile appfw_prof_xml -XMLMaxElementDepthCheck ON
set appfw profile appfw_prof_xml -XMLMaxElementDepth 10
set appfw profile appfw_prof_xml -XMLMaxElements 10000
set appfw profile appfw_prof_xml -XMLMaxFileSize 10000000

# == AppFW Policies ==
add appfw policy appfw_pol_all "true" appfw_prof_strict
add appfw policy appfw_pol_api "HTTP.REQ.URL.PATH.STARTSWITH(\"/api/\")" appfw_prof_api
add appfw policy appfw_pol_xml "HTTP.REQ.HEADER(\"Content-Type\").CONTAINS(\"xml\")" appfw_prof_xml
add appfw policy appfw_pol_admin "HTTP.REQ.URL.PATH.STARTSWITH(\"/admin/\")" appfw_prof_strict
add appfw policy appfw_pol_learning "HTTP.REQ.URL.PATH.STARTSWITH(\"/beta/\")" appfw_prof_learning

# == Relaxation Rules (Start URLs) ==
bind appfw profile appfw_prof_strict -startURL "/health"
bind appfw profile appfw_prof_strict -startURL "/status"
bind appfw profile appfw_prof_strict -startURL "^/public/.*$" -isRegex REGEX

# == Relaxation Rules (SQL Injection) ==
bind appfw profile appfw_prof_strict -SQLInjection "^search$" ".*" -isValueRegex REGEX -formActionURL "^/search.*$" -isFormActionRegex REGEX

# == Relaxation Rules (XSS) ==
bind appfw profile appfw_prof_strict -crossSiteScripting "^description$" ".*" -formActionURL "^/submit.*$" -isFormActionRegex REGEX

# == Deny URL Patterns ==
bind appfw profile appfw_prof_strict -denyURL "^.*\\.bak$"
bind appfw profile appfw_prof_strict -denyURL "^.*\\.old$"
bind appfw profile appfw_prof_strict -denyURL "^/\\..*$"
bind appfw profile appfw_prof_strict -denyURL "^.*wp-admin.*$"

# == Field Format Rules ==
bind appfw profile appfw_prof_strict -fieldFormat "email" "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$" 1 254

# == Content Type Rules ==
bind appfw profile appfw_prof_strict -contentType "application/json"
bind appfw profile appfw_prof_strict -contentType "application/xml"
bind appfw profile appfw_prof_strict -contentType "text/html"
bind appfw profile appfw_prof_strict -contentType "application/x-www-form-urlencoded"

# == Cookie Consistency Rules ==
bind appfw profile appfw_prof_strict -cookieConsistency "JSESSIONID"
bind appfw profile appfw_prof_strict -cookieConsistency "PHPSESSID"

# == vServer for AppFW ==
add lb vserver secure_app_vs SSL 10.1.1.100 443
add serviceGroup sg_secure_app HTTP
add server web1 10.10.1.10
add server web2 10.10.1.11
bind serviceGroup sg_secure_app web1 80
bind serviceGroup sg_secure_app web2 80
bind lb vserver secure_app_vs sg_secure_app

# == Bind AppFW Policies ==
bind lb vserver secure_app_vs -policyName appfw_pol_api -priority 100 -gotoPriorityExpression NEXT -type REQUEST
bind lb vserver secure_app_vs -policyName appfw_pol_xml -priority 200 -gotoPriorityExpression NEXT -type REQUEST
bind lb vserver secure_app_vs -policyName appfw_pol_all -priority 1000 -gotoPriorityExpression END -type REQUEST

# == Global AppFW Settings ==
set appfw settings -defaultProfile appfw_prof_strict -undefAction BLOCK -sessionTimeout 900
