# Section 1.10: AAA vServers (Legacy)
# Tests: aaa vserver, authentication policies
# Requires: enable ns feature AAA
# NOTES:
#   - Classic auth policies (ldapPolicy, radiusPolicy) are deprecated - use "add authentication policy" instead
#   - When using -Authentication ON, -authenticationHost is REQUIRED
#   - Passwords/keys are encrypted in running config output

# Enable AAA feature first
enable ns feature AAA

# LDAP authentication action
add authentication ldapAction ldap_act_ad -serverIP 10.10.10.200 -serverPort 389 -ldapBase "DC=example,DC=com" -ldapBindDn "CN=svc_netscaler,OU=ServiceAccounts,DC=example,DC=com" -ldapBindDnPassword "ServicePassword123" -ldapLoginName sAMAccountName -groupAttrName memberOf -subAttributeName CN

# LDAP authentication policy (WARNING: Classic syntax, deprecated)
add authentication ldapPolicy ldap_pol_ad ns_true ldap_act_ad

# RADIUS authentication action
add authentication radiusAction radius_act_primary -serverIP 10.10.10.201 -serverPort 1812 -radKey "RadiusSharedSecret123"

# RADIUS authentication policy (WARNING: Classic syntax, deprecated)
add authentication radiusPolicy radius_pol_primary ns_true radius_act_primary

# Local authentication policy (WARNING: Classic syntax, deprecated)
add authentication localPolicy local_pol_fallback ns_true

# AAA vserver for authentication
add authentication vserver vs_aaa_auth SSL 10.1.1.170 443

# Bind authentication policies to AAA vserver
bind authentication vserver vs_aaa_auth -policy ldap_pol_ad -priority 100
bind authentication vserver vs_aaa_auth -policy radius_pol_primary -priority 200

# Backend server for testing
add server aaa_backend 10.10.10.210
add serviceGroup sg_aaa HTTP
bind serviceGroup sg_aaa aaa_backend 80

# LB vserver with AAA authentication
# NOTE: -authenticationHost is REQUIRED when -Authentication ON
add lb vserver vs_aaa_protected HTTP 10.1.1.175 80 -Authentication ON -authnVsName vs_aaa_auth -authenticationHost auth.example.com
bind lb vserver vs_aaa_protected sg_aaa
